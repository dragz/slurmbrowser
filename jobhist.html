<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <script src="https://code.jquery.com/jquery-1.12.3.js">
  </script>
  <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js">
  </script>
  <script src="mousetrap.min.js">
  </script>
<head>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css">
<title>
</title>
</head>
<body>

<p id="debug"></p>
<p> <a href="squeue.html"> squeue </a> </p>
<p>Keyboard shortcuts: f-first page, n-next, p-previous, l-last,
  s-search, r-running jobs, c-completed jobs, w-waiting jobs, a-all jobs.</p>
<table id="jobhist" class="display nowrap" cellspacing="0"
       width="100%">
  <tbody>
   <trow>
     <td>
     <img src="default.gif">
     </td>
   </trow>
  </tbody>
</table>
<p>
Credits:<br>
Developed by <a href="mailto:roy.dragseth@uit.no">Roy Dragseth</a>
using <a href="https://bottlepy.org">Bottle</a> for the server side and
<a href="https://datatables.net/">Datatables</a>
and <a href="https://craig.is/killing/mice/">Mousetrap</a> for the
client side.
</p>

<script>
$(document).ready(function() {

// cutnpaste from stackexchange
function getDataAsync(url, callback) {
    $.ajax({
        async: true,
        url: url,
        dataType: 'json',
        success: callback
    });
}


//cutnpaste from http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript 
var urlParams;
(window.onpopstate = function () {
    var match,
        pl     = /\+/g,  // Regex for replacing addition symbol with aspace
        search = /([^&=]+)=?([^&]*)/g,
        decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
        query  = window.location.search.substring(1);

    urlParams = {};
    while (match = search.exec(query))
       urlParams[decode(match[1])] = decode(match[2]);
})();


function renderTable(jobhistData){
    var user = urlParams['user'];
    var visibleCols = jobhistData['headers']
    var headers = jobhistData['headers'];
    var jobs = jobhistData['jobs'];
    var visibleIdx = [];
    for (c in visibleCols) {
        visibleIdx.push(headers.indexOf(visibleCols[c]));
    }

    var cols = [];
    for (c in visibleCols) {
        cols[c] = { title: visibleCols[c], data: visibleIdx[c],
                    className: "dt-body-right" };
    }
    cols[cols.length-1].className = "dt-body-left";

    var jobhist = $('#jobhist').DataTable({
          data : jobs,
          columns : cols,
          order : [[ 0, "asc"]],
          pageLength : 25, 
          lengthMenu : [ [ 25, 50, 100, -1], [ 25, 50, 100, "All"] ],
          scrollX : true,
          stateSave : true,
	  columnDefs : [
                  { render : function(data, type, row) {
                                 return "<a href=job.html?jobid=" + data + 
                                       ">" + data + "</a>";
                               
                             },
                    targets : 0
                  }
          ]
    } );
//   document.getElementById('debug').innerHTML = ;

   Mousetrap.bind('n', function() {
      jobhist.page( 'next' ).draw( 'page' );
    });
   Mousetrap.bind('p', function() {
      jobhist.page( 'previous' ).draw( 'page' );
    });
   Mousetrap.bind('f', function() {
      jobhist.page( 'first' ).draw( 'page' );
    });
   Mousetrap.bind('l', function() {
      jobhist.page( 'last' ).draw( 'page' );
    });
   Mousetrap.bind('s', function() {
      $('div.dataTables_filter input').focus();
    }, 'keyup');

   Mousetrap.bind('r', function() {
      jobhist.column(4).search('RUNNING').draw();           
    });
   Mousetrap.bind('c', function() {
      jobhist.column(4).search('COMPLETED|TIMEOUT', true).draw();           
    });
   Mousetrap.bind('w', function() {
      jobhist.column(4).search('PENDING').draw();           
    });
   Mousetrap.bind('a', function() {
      jobhist.column(4).search('.', true).draw();           
    });

}

//Pull all queue info from the server as json and render the htmltable
getDataAsync("../data/jobhist/"+urlParams['user'], renderTable);

});
</script>

<script>
</script>

</body>
</html>
