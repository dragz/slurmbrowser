<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <script src="https://code.jquery.com/jquery-1.12.3.js">
  </script>
  <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js">
  </script>
<head>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css">
<style>
#rightalign td {
    text-align : right;
}
#leftalign td {
    text-align : left;
}
</style>

<title>
</title>
</head>
<body>

<table id="jobstats" class="display" cellspacing="10">
<p id="debug"></p>
<table id="cpumapping" class="display" cellspacing="0" 
       width="20%" align="left">
  <thead> 
    <th>Nodes</th><th>CPU_IDs</th><th>Mem</th>
  </thead>
  <tbody>
  </tbody>
</table>
<table id="jobgraphs" class="display nowrap" cellspacing="0" width="100%"></table>

<script>
$(document).ready(function() {

// cutnpaste from stackexchange
function getDataAsync(url, callback) {
    $.ajax({
        async: true,
        url: url,
        dataType: 'json',
        success: callback
    });
}

//cutnpaste from http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript 
var urlParams;
(window.onpopstate = function () {
    var match,
        pl     = /\+/g,  // Regex for replacing addition symbol with aspace
        search = /([^&=]+)=?([^&]*)/g,
        decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
        query  = window.location.search.substring(1);

    urlParams = {};
    while (match = search.exec(query))
       urlParams[decode(match[1])] = decode(match[2]);
})();

function expandHostlist(hostlist) {
   return hostlist.split(",");
}

var jobid = urlParams['jobid'];

function displayGraphs(jobinfo)
{
   //URGH timezone issue!!! How do one get the clients TZ?
   //ganglias rrdtool seems to use UTC so we are off by two hours
   var start = (new Date(jobinfo['StartTime'])).getTime()/1000 - 3600 ;
   var end   = (new Date(jobinfo['EndTime'])).getTime()/1000 - 3600 ;
   var hostlist = jobinfo['expanded_nodelist'];
   var base_graph_url = "<IMG SRC='http://stallo-adm.uit.no/ganglia/graph.php?g=GRAPH_NAME&z=medium&c=Stallo&s=descending&hc=4&mc=2&h=HOSTNAME.local&r=custom&cs=STARTTIME&ce=now'>";

   var graphlist = ["load_report",
                 "cpu_report",
                 "mem_report",
                 "network_report",
                 "packet_report",
                 "nfs_report",
                 "infiniband_report",
                 "infinibandpkt_report",
                 "lustre_report"];

   var cols = [];
   for (g in graphlist) {
       cols.push({ title : graphlist[g]});
   }
   var graphtable = [];
   for (h in hostlist) {
       row = [];
       for (g in graphlist) {
          row.push(base_graph_url.replace("GRAPH_NAME", graphlist[g])
                                 .replace("HOSTNAME", hostlist[h])
                                 .replace("STARTTIME", start));
       }
       graphtable.push(row);
   }
   
   $('#jobgraphs').DataTable({
         data : graphtable,
         columns : cols,
         stateSave : true,
         paging : false,
         info : false,
         searching : false         
   } );
}

function displayJobInfo(jobinfo) {
    var jobInfoTable = [['JobId', 'JobName', 'UserId', 'Account', 'QOS', 
                          'Partition', 'Shared' ],
                        ['SubmitTime', 'StartTime', 'EndTime', 'TimeLimit', 'RunTime'],
                        ['NumCPUs', 'NumNodes', 'MinMemoryCPU']];
    var htmltable = "<table><tr valign='top'>";
    var i, j;
    for (i in jobInfoTable) {
        htmltable += "<td><table  id='jobinformation'>";
	for (j in jobInfoTable[i]) {
	    var elem = jobInfoTable[i][j];
	    htmltable += "<tr><td id='rightalign'>" + elem +
    "</td><td>=</td><td id='leftalign'>" + jobinfo[elem] + "</td></tr>"; 
        }
        htmltable += "</table></td>";
    }
    htmltable += "</tr></table>";
    var nodelist = "<p>NodeList=" + jobinfo['NodeList'] + "</p>";
    document.getElementById('jobstats').innerHTML = htmltable;

    $('#cpumapping').DataTable({
         data : jobinfo['cpu_mapping']['nodes'],
         stateSave : true,
         searching : false,
         paging : false,
         ordering : false,
         info : false,
         columnDefs : [
           { render : function(data, type, row) {
                    return data.toString().replace(/,c/g, " c");
                    },
             targets : 0
           }
         ]
      } );
}

function renderPage(jobinfo)
{
   displayJobInfo(jobinfo);
   displayGraphs(jobinfo);
}

getDataAsync("../data/job/" + jobid, renderPage);
});

</script>

</body>
</html>
