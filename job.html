<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <script src="https://code.jquery.com/jquery-1.12.3.js">
  </script>
  <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js">
  </script>
<head>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css">
<style>
#rightalign td {
    text-align : right;
}
#leftalign td {
    text-align : left;
}
</style>

<title>
</title>
</head>
<body>
<p> <a href="squeue.html"> squeue </a> </p>
<table>
  <tbody>
    <tr>
      <td>
	<table id="jobstats" class="display" cellspacing="10">
	</table>
      </td>
      <td>
	<table id="cpumapping" class="display" cellspacing="0" 
	       width="40%" align="left">
	  <thead> 
	    <th>Nodes</th><th>CPU_IDs</th><th>Mem</th>
	  </thead>
	  <tbody>
	  </tbody>
	</table>
      </td>
    </tr>
  </tbody>
</table>


<table id="jobprocs" class="display nowrap" cellspacing="0"
       width="100%">
</table>
<table id="jobgraphs" class="display nowrap" cellspacing="0" width="100%"></table>

<script>
$(document).ready(function() {

// cutnpaste from stackexchange
function getDataAsync(url, callback) {
    $.ajax({
        async: true,
        url: url,
        dataType: 'json',
        success: callback
    });
}

//cutnpaste from http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript 
var urlParams;
(window.onpopstate = function () {
    var match,
        pl     = /\+/g,  // Regex for replacing addition symbol with aspace
        search = /([^&=]+)=?([^&]*)/g,
        decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
        query  = window.location.search.substring(1);

    urlParams = {};
    while (match = search.exec(query))
       urlParams[decode(match[1])] = decode(match[2]);
})();

function expandHostlist(hostlist) {
   return hostlist.split(",");
}

var jobid = urlParams['jobid'];

function remap_jobinfo(jobinfo)
{
  //A quick hack to map the format coming from sacct to
  //the one coming from scontrol
  if (jobinfo["JobID"]) {
    jobinfo["JobId"] = jobinfo["JobID"];
    jobinfo["StartTime"] = jobinfo["Start"];
    jobinfo["EndTime"] = jobinfo["End"];
    jobinfo["UserId"] = jobinfo["User"];
    jobinfo["RunTime"] = jobinfo["Elapsed"];
    jobinfo["NumNodes"] = jobinfo["NNodes"];
    jobinfo["NumCPUs"] = jobinfo["NCPUS"];
  }
  return jobinfo;
}

function displayGraphs(jobinfo)
{
   //URGH timezone issue!!! How do one get the clients TZ?
   //ganglias rrdtool seems to use UTC so we are off by one or two hours
   var start = (new Date(jobinfo['StartTime'])).getTime()/1000 - 0*3600 ;
   var end   = (new Date(jobinfo['EndTime'])).getTime()/1000 - 0*3600 ;
   var now   = (new Date()).getTime()/1000 - 3600 ;
   if (end > now) {
      end = "now";
   }
   var hostlist = jobinfo['expanded_nodelist'];
   var base_graph_url = "<IMG SRC='../graph/?name=GRAPH_NAME&hostname=HOSTNAME&start=STARTTIME&end=ENDTIME'>";

   var graphlist = ["load_report",
                 "cpu_report",
                 "mem_report",
                 "network_report",
                 "packet_report",
                 "nfs_report",
                 "infiniband_report",
                 "infinibandpkt_report",
                 "lustre_report"];

   var cols = [];
   for (g in graphlist) {
       cols.push({ title : graphlist[g]});
   }
   var graphtable = [];
   for (h in hostlist) {
       row = [];
       for (g in graphlist) {
          row.push(base_graph_url.replace("GRAPH_NAME", graphlist[g])
                                 .replace("HOSTNAME", hostlist[h])
                                 .replace("STARTTIME", start)
                                 .replace("ENDTIME", end)
          );
       }
       graphtable.push(row);
   }
   
   $('#jobgraphs').DataTable({
         data : graphtable,
         columns : cols,
         stateSave : true,
         paging : false,
         info : false,
         searching : false         
   } );
}

function displayJobInfo(jobinfo) {
    var jobInfoTable = [['JobId', 'JobName', 'UserId', 'Account', 'QOS', 
                          'Partition', 'Shared' ],
                        ['SubmitTime', 'StartTime', 'EndTime', 'TimeLimit', 'RunTime'],
                        ['NumCPUs', 'NumNodes', 'MinMemoryCPU']];
    var htmltable = "<table><tr valign='top'>";
    var i, j;
    for (i in jobInfoTable) {
        htmltable += "<td><table  id='jobinformation'>";
	for (j in jobInfoTable[i]) {
	    var elem = jobInfoTable[i][j];
	    htmltable += "<tr><td id='rightalign'>" + elem +
    "</td><td>=</td><td id='leftalign'>" + jobinfo[elem] + "</td></tr>"; 
        }
        htmltable += "</table></td>";
    }
    htmltable += "</tr></table>";
    var nodelist = "<p>NodeList=" + jobinfo['NodeList'] + "</p>";
    document.getElementById('jobstats').innerHTML = htmltable;

    if (! jobinfo['JobID']) {
      $('#cpumapping').DataTable({
           data : jobinfo['cpu_mapping']['nodes'],
           stateSave : true,
           searching : false,
           paging : false,
           ordering : false,
           info : false,
           columnDefs : [
             { render : function(data, type, row) {
                      return data.toString().replace(/,c/g, " c");
                      },
               targets : 0
             } 
           ]
        } );
      }
    else {
      document.getElementById('cpumapping').innerHTML = nodelist;
    }
}

function displayJobProcs(jobinfo)
{
   if (! jobinfo['procs']) {
      document.getElementById('jobprocs').innerHTML = "";
      return;
   }

   var procs = jobinfo['procs'];
   var procinfo = [];

   for (var i in procs) {
       var hostname = procs[i][0];
       var psdict = procs[i][1];
       for (var j in psdict) {
           var psinfo = psdict[j]["val"];
           psinfo['hostname'] = hostname;
           psinfo['ps'] = j;
           procinfo.push(psinfo);
       }
   }

   var procTable = $('#jobprocs').DataTable({
         processing : true,
         data : procinfo,
         columns : [
            { title: "Node", data: "hostname" },
            { title: "User", data: "user" },
            { title: "%CPU", data: "%cpu" },
            { title: "%mem", data: "%mem" },
            { title: "VM",   data: "vm" },
            { title: "RSS",  data: "size" },
            { title: "Data", data: "data" },
            { title: "Command", data: "cmd" },
          ],
         order : [[ 3, "desc" ]] // sort by %cpu
        } );
}

function renderPage(jobinfo)
{
     jobinfo = remap_jobinfo(jobinfo);
     displayJobInfo(jobinfo);
     if (jobinfo['GANGLIA'] === 1) {
	 displayJobProcs(jobinfo);
	 displayGraphs(jobinfo);
     }
}

getDataAsync("../data/job/" + jobid, renderPage);
});

</script>

</body>
</html>
